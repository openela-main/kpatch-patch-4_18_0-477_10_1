From fa70afb5fa3c515c568433377ba0647c4e576a9f Mon Sep 17 00:00:00 2001
From: Ryan Sullivan <rysulliv@redhat.com>
Date: Wed, 6 Sep 2023 09:01:28 -0400
Subject: [KPATCH CVE-2023-3776] kpatch fixes for CVE-2023-3776

Kernels:
4.18.0-477.10.1.el8_8
4.18.0-477.13.1.el8_8
4.18.0-477.15.1.el8_8
4.18.0-477.21.1.el8_8

Changes since last build:
arches: x86_64 ppc64le
cls_fw.o: changed function: fw_set_parms
---------------------------

Kpatch-MR: https://gitlab.com/redhat/prdsc/rhel/src/kpatch/rhel-8/-/merge_requests/141
Approved-by: Joe Lawrence (@joe.lawrence)
Approved-by: Yannick Cote (@ycote1)
Modifications: none

commit 917b5da2b4cb069de2e19335df6b0566d9655884
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Fri Aug 4 17:36:13 2023 +0200

    net/sched: cls_fw: Fix improper refcount update leads to use-after-free

    Bugzilla: https://bugzilla.redhat.com/2225647
    CVE: CVE-2023-3776
    Y-Commit: 9336716767f5ede015afb2ef16f724db07b37e46

    O-Bugzilla: https://bugzilla.redhat.com/show_bug.cgi?id=2225103
    O-CVE: CVE-2023-3776
    Upstream Status: net.git commit 0323bce598ee

    commit 0323bce598eea038714f941ce2b22541c46d488f
    Author: M A Ramdhan <ramdhan@starlabs.sg>
    Date:   Wed Jul 5 12:15:30 2023 -0400

        net/sched: cls_fw: Fix improper refcount update leads to use-after-free

        In the event of a failure in tcf_change_indev(), fw_set_parms() will
        immediately return an error after incrementing or decrementing
        reference counter in tcf_bind_filter().  If attacker can control
        reference counter to zero and make reference freed, leading to
        use after free.

        In order to prevent this, move the point of possible failure above the
        point where the TC_FW_CLASSID is handled.

        Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
        Reported-by: M A Ramdhan <ramdhan@starlabs.sg>
        Signed-off-by: M A Ramdhan <ramdhan@starlabs.sg>
        Acked-by: Jamal Hadi Salim <jhs@mojatatu.com>
        Reviewed-by: Pedro Tammela <pctammela@mojatatu.com>
        Message-ID: <20230705161530.52003-1-ramdhan@starlabs.sg>
        Signed-off-by: Jakub Kicinski <kuba@kernel.org>

    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Signed-off-by: Lucas Zampieri <lzampier@redhat.com>

Signed-off-by: Ryan Sullivan <rysulliv@redhat.com>
---
 net/sched/cls_fw.c | 10 +++++-----
 1 file changed, 5 insertions(+), 5 deletions(-)

diff --git a/net/sched/cls_fw.c b/net/sched/cls_fw.c
index 6a0d3ee00758..4240ca68cbc4 100644
--- a/net/sched/cls_fw.c
+++ b/net/sched/cls_fw.c
@@ -214,11 +214,6 @@ static int fw_set_parms(struct net *net, struct tcf_proto *tp,
 	if (err < 0)
 		return err;
 
-	if (tb[TCA_FW_CLASSID]) {
-		f->res.classid = nla_get_u32(tb[TCA_FW_CLASSID]);
-		tcf_bind_filter(tp, &f->res, base);
-	}
-
 	if (tb[TCA_FW_INDEV]) {
 		int ret;
 		ret = tcf_change_indev(net, tb[TCA_FW_INDEV], extack);
@@ -235,6 +230,11 @@ static int fw_set_parms(struct net *net, struct tcf_proto *tp,
 	} else if (head->mask != 0xFFFFFFFF)
 		return err;
 
+	if (tb[TCA_FW_CLASSID]) {
+		f->res.classid = nla_get_u32(tb[TCA_FW_CLASSID]);
+		tcf_bind_filter(tp, &f->res, base);
+	}
+
 	return 0;
 }
 
-- 
2.40.1


